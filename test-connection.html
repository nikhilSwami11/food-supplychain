<!DOCTYPE html>
<html>
<head>
    <title>MetaMask Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .error {
            background: #ffebee;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #f44336;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç MetaMask Connection Debugger</h1>
        
        <div id="status"></div>
        
        <button onclick="connectWallet()">Connect Wallet</button>
        <button onclick="checkConnection()">Check Connection</button>
        <button onclick="testContract()">Test Contract</button>
        <button onclick="clearStorage()">Clear Storage & Reload</button>
        
        <div id="output"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = '0x730063f065a34Dd638f54A2e7D73997CeD2e018c';
        const EXPECTED_NETWORK_ID = '5777';
        
        let web3;
        let account;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            output.appendChild(div);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        async function connectWallet() {
            clearOutput();
            
            try {
                if (!window.ethereum) {
                    log('‚ùå MetaMask is not installed!', 'error');
                    return;
                }

                log('üîÑ Requesting account access...', 'info');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                account = accounts[0];
                web3 = new Web3(window.ethereum);
                
                log(`‚úÖ Connected to account: <code>${account}</code>`, 'success');
                
                await checkConnection();
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function checkConnection() {
            clearOutput();
            
            try {
                if (!window.ethereum) {
                    log('‚ùå MetaMask is not installed!', 'error');
                    return;
                }

                web3 = new Web3(window.ethereum);
                
                // Get network info
                const chainId = await web3.eth.getChainId();
                const networkId = await web3.eth.net.getId();
                const accounts = await web3.eth.getAccounts();
                
                log(`<h3>üìä Connection Status:</h3>`, 'info');
                log(`<strong>Chain ID:</strong> ${chainId}`, 'info');
                log(`<strong>Network ID:</strong> ${networkId}`, 'info');
                log(`<strong>Expected Network ID:</strong> ${EXPECTED_NETWORK_ID}`, 'info');
                log(`<strong>Connected Account:</strong> <code>${accounts[0] || 'None'}</code>`, 'info');
                
                if (networkId.toString() === EXPECTED_NETWORK_ID) {
                    log('‚úÖ Connected to correct network (Ganache)!', 'success');
                } else {
                    log(`‚ùå Wrong network! Please switch to Localhost 7545 (Network ID: ${EXPECTED_NETWORK_ID})`, 'error');
                }
                
                // Check balance
                if (accounts[0]) {
                    const balance = await web3.eth.getBalance(accounts[0]);
                    const ethBalance = web3.utils.fromWei(balance, 'ether');
                    log(`<strong>Balance:</strong> ${ethBalance} ETH`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testContract() {
            clearOutput();
            
            try {
                if (!web3) {
                    log('‚ùå Please connect wallet first!', 'error');
                    return;
                }

                log('üîÑ Testing contract connection...', 'info');
                
                // Check if contract exists
                const code = await web3.eth.getCode(CONTRACT_ADDRESS);
                
                if (code === '0x' || code === '0x0') {
                    log(`‚ùå No contract found at address: <code>${CONTRACT_ADDRESS}</code>`, 'error');
                    log('The contract is not deployed to this network!', 'error');
                } else {
                    log(`‚úÖ Contract found at: <code>${CONTRACT_ADDRESS}</code>`, 'success');
                    log(`<strong>Contract bytecode length:</strong> ${code.length} characters`, 'info');
                    
                    // Try to call contractOwner
                    const CONTRACT_ABI = [
                        {
                            "inputs": [],
                            "name": "contractOwner",
                            "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                            "stateMutability": "view",
                            "type": "function"
                        }
                    ];
                    
                    const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                    const owner = await contract.methods.contractOwner().call();
                    
                    log(`‚úÖ Contract Owner: <code>${owner}</code>`, 'success');
                    
                    const accounts = await web3.eth.getAccounts();
                    if (accounts[0] && accounts[0].toLowerCase() === owner.toLowerCase()) {
                        log('üéâ You are the contract owner (Admin)!', 'success');
                    } else {
                        log('‚ÑπÔ∏è You are not the contract owner', 'info');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Error testing contract: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('‚úÖ Storage cleared! Reloading page...', 'success');
            setTimeout(() => window.location.reload(), 1000);
        }

        // Auto-check on load
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                document.getElementById('status').innerHTML = 
                    '<div class="success">‚úÖ MetaMask detected!</div>';
                
                // Check if already connected
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    web3 = new Web3(window.ethereum);
                    account = accounts[0];
                    log(`Already connected to: <code>${account}</code>`, 'info');
                }
            } else {
                document.getElementById('status').innerHTML = 
                    '<div class="error">‚ùå MetaMask not detected! Please install MetaMask.</div>';
            }
        });

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                log(`üîÑ Account changed to: <code>${accounts[0]}</code>`, 'info');
                account = accounts[0];
            });

            window.ethereum.on('chainChanged', (chainId) => {
                log(`üîÑ Network changed to Chain ID: ${parseInt(chainId, 16)}`, 'info');
                window.location.reload();
            });
        }
    </script>
</body>
</html>

